<head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../css/main.css" /> 
           <script src="../../js/jquery.js"></script> 
           <script src="../../js/main.js"></script> 
           </head> 
           <head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../css/main.css" /> 
           <script src="../../../js/jquery.js"></script> 
           <script src="../../../js/main.js"></script> 
           </head>  
           <head>  
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../../css/main.css" /> 
           <script src="../../../../js/jquery.js"></script> 
           <script src="../../../../js/main.js"></script> 
           </head>
<h1>去除突起干扰工具</h1>

<h2>功能</h2>

<p>在3D应用场景中，受3D相机的成像原理、参数设置，或者产品材质的影响，采集到的深度图像中会有一部分干扰数据，这部分干扰数据会严重影响测量结果，为了提升测量结果的准确性，消除干扰数据的影响，可以使用去除突起干扰工具。去除突起干扰工具的功能是：去除深度图像中的干扰数据点（干扰数据点，即深度图像中明显高于或低于周围的点，通常是噪声干扰点），并在去除后，通过邻域范围内的有效数据点，对干扰数据点的位置进行填充，提高深度图像的完整性。</p>

<p> <img src="media/wps48.jpg" alt="img" /></p>

<p><imgnote>图1 去除突起干扰工具示意图</imgnote></p>

<h2>参数</h2>

<table>
<thead>
<tr>
<th>分类 </th>
<th> 参数名称         </th>
<th> 参数描述                                                                                                                   </th>
</tr>
</thead>
<tbody>
<tr>
<td> 属性窗口         </td>
<td> ROI类型                                                      </td>
<td> 检测区域类型，分为5种：整幅图像、矩形ROI、仿射矩形ROI、圆形ROI、椭圆ROI。 </td>
</tr>
<tr>
<td></td>
<td> 去除对象         </td>
<td> 启用ROI参数选择是时有效，用户使用矩形ROI指定重构区域。<img src="media/wps50.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 去除方向         </td>
<td> 选择作为去除对象的突起点，分为高、低以及高低对象。<img src="media/wps51.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 去除突起点数量      </td>
<td> 去除高或低突起数据点的数量。取值范围为[2, 1000]内的整数。<img src="media/wps52.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 去除阈值         </td>
<td> 允许突起数据点到基准点的最大高度值，大于去除阈值的突起点将会被去除。取值范围为(0, 1000]内的实数。<img src="media/wps53.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 启用掩模         </td>
<td> 是否启用掩模，选择“是”，则启用高级界面，通过高级界面进行掩膜设置。                                                               </td>
</tr>
<tr>
<td></td>
<td> 填充方法   </td>
<td> 去除干扰点后，会对去除后的空洞位置进行填充，该参数用于指定填充方法，分为三种：无、线性填充、非线性填充。<img src="media/wps54.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 深度值计算方法   </td>
<td> 分为4种，邻域最大、邻域最小、邻域插值、全局模式。缺失像素填充参数选择线性填充时有效。<img src="media/wps55.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 邻域像素搜索方向 </td>
<td> 分为3种，水平、垂直、双向，即在邻域模式下，对目标像素点水平方向两侧或垂直方向两侧或水平垂直方向两侧的有效像素进行分析。该参数仅在邻域模式下有效。                                                               </td>
</tr>
<tr>
<td></td>
<td> 全局模式计算方式 </td>
<td> 分为4种，全局最大，全局最小、全局平均、固定值。缺失像素填充参数选择线性填充时有效。                                                               </td>
</tr>
<tr>
<td></td>
<td> 全局模式固定值   </td>
<td> 该参数仅在全局模式计算方式选择固定值时有效，真实Z值，图像Z轴方向分辨率及偏移不同真值范围不同，单位： mm。    </td>
</tr>
<tr>
<td></td>
<td> 非线性填充方法    </td>
<td> 分为2种，平滑填充和保持边缘填充。<img src="media/wps56.jpg" alt="img" />                                                                   </td>
</tr>
<tr>
<td></td>
<td> 填充模式         </td>
<td> 分为4种，Parabolic，Parabolic Mailk，Weickert，Shock。该参数仅在保持边缘填充下有效。<img src="media/wps57.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 计算次数         </td>
<td> 对缺失像素进行填充时，算法需要对待填充像素的深度值计算的次数。<img src="media/wps58.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 更新步长         </td>
<td> 每一次迭代计算新填充值时，更新的步长大小。<img src="media/wps59.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 边缘高度阈值   </td>
<td> 领域像素高度差大于阈值的区域被认为边缘，真实Z值，图像Z轴方向分辨率不同真值范围不同，单位： mm。<img src="media/wps60.jpg" alt="img" />         </td>
</tr>
<tr>
<td></td>
<td> shock滤波比重 </td>
<td> Shock比例为：在计算填充结果时，Shock滤波所占的比重大小，其取值范围为[0,1]。<img src="media/wps61.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 平滑强度         </td>
<td> 深度图像填充过程中，对图像进行平滑滤波的强度，图像中噪声干扰越大，对应的平滑强度需增大。<img src="media/wps62.jpg" alt="img" />                                                               </td>
</tr>
<tr>
<td></td>
<td> 开启并行运算 </td>
<td> 是否开启并行运算，选择是时，算法将开启OpenMp并行计算方式，可以提升计算速度，但可能出现耗时不稳定的情况，选择否时，算法将关闭OpenMp并行计算。 </td>
</tr>
<tr>
<td></td>
<td> 线程数百分比 </td>
<td> 设置并行运算的线程数百分比，有效范围为 (0, 0.75]，对应表示(0%, 75%]百分比范围。 </td>
</tr>
<tr>
<td> 图像窗口         </td>
<td> 输入深度图像                                                 </td>
<td> 显示待去除干扰的深度图像。                                   </td>
</tr>
<tr>
<td></td>
<td> ROI区域          </td>
<td> 显示检测区域。                                                                                                             </td>
</tr>
<tr>
<td> 数据链           </td>
<td> 输入深度图像                                                 </td>
<td> 输入待去除干扰的深度图像。                                   </td>
</tr>
<tr>
<td></td>
<td> 二维线性变换     </td>
<td> 目标相对于模板的平移、旋转、缩放变换。                                                                                     </td>
</tr>
<tr>
<td></td>
<td> 高级界面         </td>
<td> 启用掩膜选择是“是”时，高级界面为掩膜设置界面。                                                                             </td>
</tr>
</tbody>
</table>


<h2>输出</h2>

<table>
<thead>
<tr>
<th>分类 </th>
<th> 参数名称 </th>
<th> 参数描述                                                                                                           </th>
</tr>
</thead>
<tbody>
<tr>
<td> 监视窗口 </td>
<td> 输出深度图像                                                 </td>
<td> 输出深度图像的长宽和像素大小，以及深度数据参数。     </td>
</tr>
<tr>
<td></td>
<td> 执行结果 </td>
<td> 工具执行结果。                                                                                                     </td>
</tr>
<tr>
<td></td>
<td> 执行时间 </td>
<td> 工具执行时间。                                                                                                     </td>
</tr>
<tr>
<td> 图像窗口 </td>
<td> 输出深度图像                                                 </td>
<td> 显示工具执行结果图像，同监视窗口的输出深度图像参数。 </td>
</tr>
<tr>
<td></td>
<td> 执行结果 </td>
<td> 显示工具执行结果，执行成功显示“OK”，执行失败显示“NG”，同监视窗口的执行结果参数。                                                       </td>
</tr>
<tr>
<td> 数据链   </td>
<td> 输出深度图像                                                 </td>
<td> 输出去除干扰+填充之后的深度图像，供其他工具使用。    </td>
</tr>
</tbody>
</table>


<h2>详细说明</h2>

<h3>1. 去除参数说明</h3>

<p>去除对象：选择作为去除对象的突起点，分为高、低以及高低对象，如图2所示。</p>

<p>高：只去除相对于周围数据点较高的突起点，如图2中红色点所示。</p>

<p>低：只去除相对于周围数据点较低的突起点，如图2中黄色点所示。</p>

<p>高低：去除相对于周围较高和较低的两种突起点，如图2中红色和黄色点所示。</p>

<p><img src="media/wps65.png" alt="img" /></p>

<p><imgnote>图2 去除对象示意图</imgnote></p>

<p><strong>去除方向:</strong>分为X、Y和XY去除方向。</p>

<ul>
<li><p>X方向：沿图像的X方向去除突起数据点，留下Y方向的突起数据点。</p></li>
<li><p>Y方向：沿图像的Y方向去除突起数据点，留下X方向的突起数据点。</p></li>
<li><p>XY方向：分别去除图像的X和Y方向的突起数据点。</p></li>
</ul>


<p><img src="media/wps66.png" alt="img" /></p>

<p><imgnote>图3 去除大小示意图</imgnote></p>

<p><strong>去除大小：</strong>指去除高或低突起数据点的数量，如图3所示，去除高突起数据点的去除大小为2，去除低突起数据点的去除大小为3。</p>

<p><strong>基准点：</strong>指将高突起点或低突起点去除时的参考点，如图3中黄色点所示。去除大小的不同，选择的基准点也不一样。</p>

<p><strong>去除阈值：</strong>指允许突起数据点到基准点的最大高度值，大于去除阈值的突起点将会被去除，如图3所示。</p>

<h3>2. 线性填充参数说明</h3>

<p>线性填充的本质是对缺失像素的邻域有效像素或全图像素进行分析，为缺失像素计算深度值。因此，深度值计算方式可分为邻域模式和全局模式</p>

<p><strong>邻域模式：</strong>通过分析缺失像素的邻域像素（水平方向、垂直方向或双向）来计算缺失像素的深度值。具体来说，邻域模式包括邻域最大、邻域最小、邻域插值三种模式。其中，邻域最大/邻域最小以缺失像素邻域范围内最大/最小的深度值作为处理结果。邻域插值基于邻域像素的位置和深度进行线性插值。</p>

<p><strong>全局模式：</strong>通过分析全图中所有有效像素来计算缺失像素的深度值，包括全局最大、全局最小、全局平局和固定值四种方法。全局最大/全局最小/全局平均以全图的最大/最小/平均有效像素值来填充所有无效像素。固定值方法以用户输入的数值填充缺失像素。</p>

<h3>3. 非线性填充参数说明</h3>

<p><img src="media/wps67.png" alt="img" /></p>

<p><imgnote>图4 非线性填充参数示意图</imgnote></p>

<p><strong>填充方法：</strong>缺失像素非线性填充工具使用的填充方法，目前包括：平滑填充和边缘保持填充两种方式。顾名思义，平滑填充，在缺失像素的填充过程中，像素的深度值是平滑过渡的，适用于平坦区域的缺失像素填充；边缘保持填充，则在填充过程中，可以对物体的边缘信息有较好的保留。具体示意图如图4(a)和4(b)所示。</p>

<p><strong>填充模式：</strong>边缘保持填充方法下的几种填充模式，主要包括：Parabolic，Parabolic Mailk，Weickert，Shock等几种填充模式。</p>

<p><strong>计算次数：</strong>对缺失像素进行填充时，需要对待填充像素的深度值计算的次数。如图4&copy;所示，随着计算次数的增加，缺失像素的填充效果不断改善。</p>

<p><strong>更新步长：</strong>每一次迭代计算新填充值时，更新的步长大小。</p>

<p><strong>边缘高度阈值（原名：对比度阈值）</strong>邻域像素高度差大于阈值的区域被认为边缘。图4(d)所示为，边缘高度阈值设置为40时，平坦区域与边缘区域划分的一个结果。值得注意的是，一个像素既可以与其邻域像素构成平坦区域，也可以同时与其他邻域像素构成边缘区域。例如：图4(d)中56与78的梯度值为28，小于边缘高度阈值，此时56对应的像素与78对应的像素构成平坦区域；同时，78与130的梯度值为52，此时78对应的像素与130对应的像素构成边缘区域。</p>

<p>如图4(e)所示，为边缘高度阈值与填充区域内边缘保持效果的大致关系：一般而言，随着边缘高度阈值减小，边缘保持效果可以得到提高。</p>

<p><strong>shock滤波比重（原名：锐化比例）：</strong>Shock填充模式下，缺失像素填充值由图像的平滑滤波值和Shock滤波值按比例相加计算得到。Shock比例为：填充结果中，Shock滤波所占的比重大小，其取值范围为[0, 1]。如果Shock比例为0，则代表填充结果由图像平滑滤波计算而成，如果Shock比例为1，则代表填充结果由Shock滤波计算而成。该参数仅在边缘保持填充方法下的Shock模式下设置。图4(f)所示，为Shock比例与填充区域内边缘保持效果的大致关系：一般而言，随着Shock比例的增加，边缘保持效果可以得到提高。</p>

<p><strong>平滑强度：</strong>深度图像填充过程中，对图像进行平滑滤波的强度，图像中噪声干扰越大，对应的平滑强度需增大。</p>

<h3>使用向导</h3>

<p><strong>Step 1 去除参数的设置</strong></p>

<p>主要是设置去除对象（高：去除向上突起的干扰点，低：去除向下突起的干扰点，高低：向上向下的突起干扰点都去除）、去除方向（X：沿X方向去除，Y：沿Y方向去除，XY：两个方向都要去除）、去除大小（越大，去除的突起点就越多）和去除阈值（越小，去除的突起点就越多）。</p>

<p><strong>Step 2 填充参数的设置</strong></p>

<p>填充方法分为3种，不填充、线性填充、非线性填充。</p>

<ul>
<li><p><strong>不填充：</strong>去除突起干扰点之后，不做任何填充，仅输出去除突起干扰点后的深度图像。</p></li>
<li><p><strong>线性填充：</strong>去除突起干扰点之后，使用线性填充方法进行填充，并输出填充后的深度图像。</p>

<ul>
<li>需要设置的参数主要是<strong>深度值计算方法参数</strong>（以领域最大为例，以缺失像素两端的较大值填充）、<strong>领域像素搜索方法</strong> （以水平为例：按图像的X方向水平进行填充）、<strong>全局模式计算方法</strong>（全局最大：图像的最大值进行填充；固定值：按设定的固定值进行填充）。</li>
</ul>
</li>
<li><p><strong>非线性填充：</strong>去除突起干扰点之后，使用非线性填充方法进行填充，并输出填充后的深度图像。</p></li>
<li><p>需要设置的参数；若填充方法设置为平滑填充时，此时仅需要对<strong>计算次数</strong>参数进行设置；若填充方法为边缘保持填充时，需要对<strong>计算次数</strong>、<strong>更新步长</strong>、<strong>平滑强度</strong>、<strong>边缘高度阈值</strong>、<strong>shock滤波比重</strong>等参数进行设置：</p></li>
<li><p><strong>第一步：选择填充模式：</strong>边缘保持填充方法下的几种填充模式，主要包括：Parabolic，PeronaMailk，Weickert，Shock等几种填充模式。几种模式的特点以及适用场景可参考下方表格。</p>

<p><strong>第二步：更新步长：</strong>每一次迭代计算新填充值时，更新的步长大小。<strong>更新步长默认为1，更新步长一般增大到10即可</strong>；</p>

<p><strong>第三步：计算次数：</strong>先把计算次数设一个较大值，如5000，10000，确保后续调参时，效果不会受到计算次数不够而达不到填充效果。</p>

<p><strong>第四步：平滑强度：</strong>深度图像填充过程中，对图像进行平滑滤波的强度，图像中噪声干扰越大，对应的平滑强度需增大。<strong>Shock模式下平滑强度一般设置为3</strong>，根据实际的填充效果，如果待填充区域的填充结果有较大的块状区域，需增大平滑强度；<strong>Parabolic, Parabolic Mailk和Weickert模式下的平滑强度一般设置小于1</strong>，根据采集的深度图像的质量，以及实际的填充结果（待填充区域的填充结果有较大的块状区域），此时可适当增大平滑强度。</p>

<p><strong>第五步：边缘高度阈值（原名：对比度阈值）</strong>邻域像素高度差大于阈值的区域被认为边缘。上图(d)所示为，边缘高度阈值设置为40时，平坦区域与边缘区域划分的一个结果。值得注意的是，一个像素既可以与其邻域像素构成平坦区域，也可以同时与其他邻域像素构成边缘区域。例如：上图(d)中56与78的梯度值为28，小于边缘高度阈值，此时56对应的像素与78对应的像素构成平坦区域；同时，78与130的梯度值为52，此时78对应的像素与130对应的像素构成边缘区域。</p>

<p>实际项目中边缘高度阈值需要多次调试，才能得到需要的值。可以通过效果了解到参数过大还是过小，阈值过大会出现如左图的效果，边缘部分过于塌陷或粘连；阈值过小会出现右图现象，出现好几层边缘。</p>

<p><img src="media/16.png" alt="16" /><img src="media/15.png" alt="15" /></p>

<p>边缘高度阈值的设置需根据边缘梯度差来确定，具体可参照边缘高度阈值的定义；<strong>一般而言，随着边缘高度阈值减小，边缘保持效果可以得到提高</strong>，如上图(e)所示。</p>

<p><strong>第五步：shock滤波比重（原名：锐化比例）：</strong>Shock填充模式下，缺失像素填充值由图像的平滑滤波值和Shock滤波值按比例相加计算得到。Shock滤波比重为：填充结果中，Shock滤波所占的比重大小，其取值范围为[0, 1]。如果Shock滤波比重为0，则代表填充结果由图像平滑滤波计算而成，如果Shock滤波比重为1，则代表填充结果由Shock滤波计算而成。该参数仅在边缘保持填充方法下的Shock模式下设置。如上图(f)所示，为Shock比例与填充区域内边缘保持效果的大致关系：一般而言，随着Shock滤波比重的增加，边缘保持效果可以得到提高。</p>

<p><strong>第六步：计算次数：</strong>慢慢把计算次数降下来，在不影响处理效果的前提下减少工具耗时。</p></li>
</ul>


<p>下表为边缘保持填充下的几种方法特点以及适用场景，用户可根据最终需要达到的填充效果对方法进行选用。</p>

<table>
<thead>
<tr>
<th> 填充方法        </th>
<th> 填充模式                                                     </th>
<th> 方法特点                                                     </th>
<th> 适用场景                                                     </th>
</tr>
</thead>
<tbody>
<tr>
<td> 平滑填充        </td>
<td> 平滑填充                                                     </td>
<td> 填充结果与周围像素之间平滑过渡                               </td>
<td> 适用于平坦区域内的缺失像素填充，包括水平区域和倾斜区域等。需对迭代次数进行设置，根据区域大小一般设置为200-1000左右。 </td>
</tr>
<tr>
<td> 边缘保持填充    </td>
<td> Parabolic                                                    </td>
<td> 填充结果可以减缓缺失像素在边缘处的平滑过渡，但不能完全消除平滑效应 </td>
<td> 建议优先使用Shock模式和Parabolic Mailk模式对深度图像进行填充 </td>
</tr>
<tr>
<td></td>
<td> Parabolic Mailk </td>
<td> 填充结果可以基本消除缺失像素在图像边缘处的平滑效应。耗时相对Weickert较短 </td>
<td> 适用边缘区域内的缺失像素填充，其中边缘区域可处于水平区域内部或倾斜区域内部。该模式需要对迭代次数，迭代步长，边缘高度阈值，平滑强度等参数进行设置                                                           </td>
</tr>
<tr>
<td></td>
<td> Weickert        </td>
<td> 填充结果可以基本消除缺失像素在图像边缘处的平滑效应。耗时相对PM较长 </td>
<td> 适用边缘区域内的缺失像素填充，其中边缘区域可处于水平区域内部或倾斜区域内部。该模式需要对迭代次数，迭代步长，边缘高度阈值，平滑强度等参数进行设置                                                           </td>
</tr>
<tr>
<td></td>
<td> Shock           </td>
<td> 填充结果可以较好地消除缺失像素在图像边缘处的平滑效应         </td>
<td> 适用于水平区域内的缺失像素填充（包括平坦区域和边缘区域）。但是不适用于倾斜区域内存在缺失像素的填充。该模式需要对迭代次数，迭代步长，边缘高度阈值，平滑强度等参数进行设置                                                          </td>
</tr>
</tbody>
</table>


<p><strong>Step 3 执行工具和输出结果</strong></p>

<p>在上述步骤之后，就可以执行工具，并得到处理后的深度图像。</p>

<h2>注意</h2>

<ul>
<li>该工具的填充部分，仅填充去除的突起点，对原图中的无效像素不进行填充。</li>
</ul>


<h2>示例工程</h2>

<p>参见“\Samples\3D\深度图\去除突起干扰工具.gvp”。</p>
