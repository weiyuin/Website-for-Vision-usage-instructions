<head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../css/main.css" /> 
           <script src="../../js/jquery.js"></script> 
           <script src="../../js/main.js"></script> 
           </head> 
           <head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../css/main.css" /> 
           <script src="../../../js/jquery.js"></script> 
           <script src="../../../js/main.js"></script> 
           </head>  
           <head>  
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../../css/main.css" /> 
           <script src="../../../../js/jquery.js"></script> 
           <script src="../../../../js/main.js"></script> 
           </head>
<h1>轮廓特征点定位工具</h1>

<h2>功能</h2>

<p>该工具查找指定直线边缘的轮廓特征点。</p>

<h2>参数</h2>

<table>
<thead>
<tr>
<th>分类 </th>
<th> 参数名称             </th>
<th> 参数描述                                                                                              </th>
</tr>
</thead>
<tbody>
<tr>
<td> 属性窗口             </td>
<td> 轮廓段数量                                                   </td>
<td> 轮廓需要的找线卡尺的数量。最大为4。     </td>
</tr>
<tr>
<td></td>
<td> X方向特征点数量      </td>
<td> X方向的轮廓特征点数量。直线的倾斜角归一化到[0,90]，角度范围在[0,45]时为X方向。                                          </td>
</tr>
<tr>
<td></td>
<td> Y方向特征点数量      </td>
<td> Y方向的轮廓特征点数量。直线的倾斜角归一化到[0,90]，角度范围在[45,90]时为Y方向。                                          </td>
</tr>
<tr>
<td></td>
<td> X方向偏移起始        </td>
<td> 各找线工具的找线结果的交点与粗找线工具搜索区域在X轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> X方向偏移终止        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在X轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> Y方向偏移起始        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在Y轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> Y方向偏移终止        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在Y轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> 精细找线卡尺最少数量 </td>
<td> 粗找线卡尺中子卡尺的数量，最小为5。只可取整数。                                                       </td>
</tr>
<tr>
<td></td>
<td> 显示精细找线工具     </td>
<td> 在图像上是否显示精细卡尺。                                                                            </td>
</tr>
<tr>
<td> 图像窗口             </td>
<td> 输入图像                                                     </td>
<td> 用来实时搜索的图像。                    </td>
</tr>
<tr>
<td> 数据链               </td>
<td> 输入图像                                                     </td>
<td> 用来实时搜索的图像。                   </td>
</tr>
<tr>
<td></td>
<td> 二维线性变换         </td>
<td> 定位轮廓的找线工具通过接收二维线性变换可在实时的图像上执行找线。                                          </td>
</tr>
<tr>
<td> 高级界面             </td>
<td> 轮廓段数量                                                   </td>
<td> 锁定轮廓需要的找线卡尺的数量。最大为4。 </td>
</tr>
<tr>
<td></td>
<td> 设置线段             </td>
<td> 点击后，图像会根据灰度的变化产生所有的轮廓线，用户可在所有的轮廓线上选出想要使用的轮廓线                                          </td>
</tr>
<tr>
<td></td>
<td> 边缘极性             </td>
<td> 缘极性是指图像边缘灰度级的过渡形式，分为3种，任意极性、亮到暗和暗到亮。                                          </td>
</tr>
<tr>
<td></td>
<td> 对比度阈值           </td>
<td> 卡尺工具默认只采用对比度评价分数，即按照边缘信号的强度来评分，输出边缘最强的点。对比度阈值的取值范围是0~255。                                          </td>
</tr>
<tr>
<td></td>
<td> 边缘选择             </td>
<td> 在查找区域内，卡尺根据不同的边缘选择，确定图像边缘的精确位置。卡尺工具的边缘属性有3种，最佳边缘、第一条边缘、最后一条边缘。                                          </td>
</tr>
<tr>
<td></td>
<td> 局外点比例           </td>
<td> 局外点就是偏离曲线较远的点。局外点比例即不参与直线拟合的点的比例，取值范围是0~0.5。                                          </td>
</tr>
<tr>
<td></td>
<td> 手动设置卡尺         </td>
<td> 选中后，支持手动设置卡尺参数，鼠标右键点击卡尺，在弹出的对话框中可以改变卡尺参数；未选中，不支持手动设置卡尺参数。                                          </td>
</tr>
<tr>
<td></td>
<td> 启用掩膜            </td>
<td> 掩膜设置是指在模板训练过程中，屏蔽掉不参与模式训练的区域，减少参与模式训练的几何特征。                                          </td>
</tr>
<tr>
<td></td>
<td> X方向特征点数量      </td>
<td> X方向的特征点数量，直线的倾斜角在[0,45]时为X方向。                                                    </td>
</tr>
<tr>
<td></td>
<td> Y方向特征点数量      </td>
<td> Y方向的特征点数量，直线的倾斜角在[45,90]时为Y方向。                                                   </td>
</tr>
<tr>
<td></td>
<td> X方向偏移起始        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在X轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> X方向偏移终止        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在X轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> Y方向偏移起始        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在Y轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> Y方向偏移终止        </td>
<td> 各找线工具的找线结果的交点与各找线工具搜索区域在Y轴方向上的偏差的最小值。见详细描述中的特征点对应。                                          </td>
</tr>
<tr>
<td></td>
<td> 精细找线卡尺最少数量 </td>
<td> 单个找线卡尺由多少子卡尺组成，最小为5。只可取整数。                                                   </td>
</tr>
<tr>
<td></td>
<td> 显示精细找线工具     </td>
<td> 在图像上是否显示精细卡尺。                                                                            </td>
</tr>
<tr>
<td></td>
<td> 输入图像 </td>
<td> 获取训练图像时从参数链的输入图像获取 </td>
</tr>
<tr>
<td></td>
<td> 加载图像 </td>
<td> 获取训练图像时从外部文件路径加载图像 </td>
</tr>
<tr>
<td></td>
<td> 获取训练图像 </td>
<td> 获取训练所需要的图像 </td>
</tr>
</tbody>
</table>


<h2>输出</h2>

<table>
<thead>
<tr>
<th>分类 </th>
<th> 参数名称              </th>
<th> 参数描述                                                                                                             </th>
</tr>
</thead>
<tbody>
<tr>
<td> 监视窗口              </td>
<td> 输入图像                                                     </td>
<td> 输入图像的宽度、高度、像素大小                         </td>
</tr>
<tr>
<td></td>
<td> 轮廓特征点结果        </td>
<td> 查找的所有轮廓点的信息。                                                                                             </td>
</tr>
<tr>
<td></td>
<td> 轮廓数量              </td>
<td> 结果中轮廓的数量。                                                                                                   </td>
</tr>
<tr>
<td></td>
<td> X方向的轮廓特征点数量 </td>
<td> X方向的特征点数量。                                                                                                  </td>
</tr>
<tr>
<td></td>
<td> X方向的轮廓特征点数量 </td>
<td> Y方向的特征点数量。                                                                                                  </td>
</tr>
<tr>
<td></td>
<td> 轮廓特征点            </td>
<td> 所有的轮廓点的相关信息组成的数组                                                                                     </td>
</tr>
<tr>
<td></td>
<td> X、Y坐标              </td>
<td> 轮廓点在图像上的位置。                                                                                               </td>
</tr>
<tr>
<td></td>
<td> 所属段输入序号        </td>
<td> 在高级属性中选择找线工具时的序号。                                                                                   </td>
</tr>
<tr>
<td></td>
<td> 所属段训练序号        </td>
<td> 训练时的序号。                                                                                                       </td>
</tr>
<tr>
<td></td>
<td> 段内序号              </td>
<td> 特征点在该线段内的序号。                                                                                             </td>
</tr>
<tr>
<td></td>
<td> 执行结果              </td>
<td> 工具执行结果。                                                                                                       </td>
</tr>
<tr>
<td></td>
<td> 执行时间              </td>
<td> 工具执行时间。                                                                                                       </td>
</tr>
<tr>
<td> 图像窗口              </td>
<td> 找线结果                                                     </td>
<td> 显示各个轮廓的找线工具的找线结果。                     </td>
</tr>
<tr>
<td></td>
<td> 特征点                </td>
<td> 显示所有的产品的轮廓特征点。                                                                                         </td>
</tr>
<tr>
<td></td>
<td> 执行结果              </td>
<td> 显示工具执行结果，执行成功显示“OK”，执行失败显示“NG”，同监视窗口的执行结果参数。                                                         </td>
</tr>
<tr>
<td> 数据链                </td>
<td> 轮廓特征点                                              </td>
<td> 轮廓的特征点数组供后续参数链调用。 </td>
</tr>
<tr>
<td>  </td>
<td> 轮廓特征点结果                                               </td>
<td> 输出提取的特征点结果。供其他工具使用，同监视窗口参数。 </td>
</tr>
</tbody>
</table>


<h2>详细说明</h2>

<h3>特征点</h3>

<p><img src="media/wps14.jpg" alt="img" /><img src="media/wps15.jpg" alt="img" /><img src="media/wps16.jpg" alt="img" /></p>

<p><imgnote>图1  轮廓段数量类型</imgnote></p>

<p>工具定义中轮廓段数量支持2、3、4三种情况，其对于的示意图如图1所示。</p>

<p><img src="media/wps17.png" alt="img" /></p>

<p><imgnote>图2  轮廓段数量类型</imgnote></p>

<p>对于非柔性变形材质，我们一般直接使用找线工具拟合得到该条边的结果，这里为了解决柔性变形的问题，如图2所示，实际的轮廓可能如虚线所示，如果直线使用一个找线工具对整条曲线做拟合会导致结果与实际轮廓有较大误差，故使用分段拟合取结果中点的方法计算特征点，从而获得更稳定的结果。</p>

<h3>特征点对应</h3>

<p><img src="media/wps18.png" alt="img" /></p>

<p><imgnote>图3  特征点对应要求示意图</imgnote></p>

<p>根据后续对位流程需求，需要满足对应边上特征点位置的对应，对于图3所示两个特征点的情况，要尽量保证D1 = D2。对于以上三种轮廓段数量类型，解决方法如下：</p>

<p><img src="media/wps19.jpg" alt="img" /></p>

<p><imgnote>图4  两段轮廓段特征点对应方法</imgnote></p>

<ul>
<li><strong>两段轮廓。</strong>如图4所示：（1）首先对两段轮廓分别应该找线工具，得到找线结果Line1和line2。(2)求出line1和line2的交点PointA。（3）根据起始偏移距离S和终止偏移距离E，分别求出PointB、PointC，在PointB和PointC之间摆放预定义数量的找线工具；对于另外一条边采用同样的方法根据S1和E1求出，PointB1、PointC1，在PointB1和PointC1之间摆放预定义数量的找线工具。</li>
</ul>


<p> <img src="media/wps20.jpg" alt="img" /></p>

<p><imgnote>图5  三段轮廓段特征点对应方法</imgnote></p>

<ul>
<li><strong>三段轮廓。</strong>如图5所示，其基本思想与两段轮廓情况类似，但是只需要设置两组起始偏移S和终止偏移E。</li>
</ul>


<p><img src="media/wps21.png" alt="img" /></p>

<p><imgnote>图6 四段轮廓段特征点对应方法</imgnote></p>

<ul>
<li><strong>四段轮廓。</strong>如图6所示，其基本思想与两段轮廓情况类似，但是只需要设置两组起始偏移S和终止偏移E。</li>
</ul>


<h3>找线结果XY方向判断和自动编号</h3>

<p><img src="media/wps22.png" alt="img" /></p>

<p><imgnote>图7 粗找线工具编号逻辑</imgnote></p>

<p>如图7所示，粗找线工具按照顺时针进行编号，这里希望实现用户随意摆放找线控件，根据找线结果进行逻辑内部判断，自动生成内部的找线工具编号，自动生成其X\Y方向属性。</p>

<p><img src="media/wps23.png" alt="img" /></p>

<p><imgnote>图8 顺时针方法判断方法</imgnote></p>

<p>1、两段轮廓：</p>

<ul>
<li><p>Step1:  XY方向判断。后续需要根据用户输入的X方向和Y方向参数进行预设点数量和偏移的计算，因而需要区分直线为X或Y方向，这里直接根据直线的角度计算，对直线角度归一化到[0,90]，直线角度小于45则为X，否则为Y方向。</p></li>
<li><p>Step2：自动编号。顺时针方向判断，区分出0和1。判断方法，如图8所示，线段0和线段1所在直线的交点为P，线段0和线段1中距离交点P较远点为P1和P2，则可得到向量P1P和向量PP2，二者之间的叉积为负则说明是顺时针方向，为正则颠倒编号（在我们的图像坐标系下叉积为正则说明是顺时针方向，否则为逆时针）。</p></li>
</ul>


<p>2、三段轮廓：</p>

<ul>
<li><p>Step1:  XY方向判断。使用和两段轮廓中一样的方法，对三段直线进行方向判断。</p></li>
<li><p>Step2：自动编号。这里首先根据方向进行分组，同为X方向或同为Y方向的编号为0或2，另外一个编号为1，采用类似两段轮廓的方法计算0和1或2和1之间的是否符合顺时针，顺时针方向者编号为0。</p></li>
</ul>


<p>3、四段轮廓：</p>

<ul>
<li><p>Step1:  XY方向判断。使用和两段轮廓中一样的方法，对四段直线进行方向判断。</p></li>
<li><p>Step2:  Y方向的两段线段中，中点X坐标小者编号为0，另外一个编号为2。</p></li>
<li><p>Step3:  计算编号为0的线段与X方向的顺时针特性，顺时针这编号为1，另外一个编号为3。</p></li>
</ul>


<p>总结：以上计算共需要直线方向判断和顺时针判断两个算法模块。该模块只在训练阶段计算，得到与原始摆放控件的对应关系。</p>

<h3>特征点输出</h3>

<p><img src="media/wps24.png" alt="img" /></p>

<p><imgnote>图9 特征点输出方向</imgnote></p>

<ul>
<li><strong>方向：</strong>对于X、Y方向特征点按从小到大输出。每一段的特征点方向具体判断如下：计算第一个特征点和最后一个特征点之间的差，为正（分X和Y）则按原始输出，为负则逆序输出。</li>
</ul>


<p><img src="media/wps25.png" alt="img" /></p>

<p><imgnote>图10 对应方向匹配匹配示意图<imgnote></p>

<ul>
<li><p><strong>对应方向匹配：</strong>对于对应方向的特征点，需要根据特征点在段内的序号进行匹配，如匹配失败，则剔除该特征点。如图10所示，上下两条边的有效匹配为3个点，上面一条边剔除了3个点。</p></li>
<li><p><strong>最小点限制：</strong>每段有效特征点个数最小为2，否则输出失败。</p></li>
</ul>


<h3>工具执行流程</h3>

<p>如图11所示为工具执行的基本流程：</p>

<p><img src="media/wps26.png" alt="img" /></p>

<p><imgnote>图11 工具总体流程图<imgnote></p>

<p>1.粗略找线模块，这里根据用户设置的轮廓段数量和找线工具参数进行找线，根据轮廓段数量对找线模块进行编号(如图12所示4轮廓段情况，编号按顺时针规则，01、03为垂直方向直线，02、4为水平方向)，该模块输出各轮廓段粗找线结果。</p>

<p>2.对找线结果XY方向判断和自动编号。</p>

<p>3.求取直线交点模块，只对相邻编号之间的直线进行交点求取，该模块输出各交点。</p>

<p>4.精细找线参数设置模块，这里需要用户设置X/Y方向的偏移数据和预设特征点数量，对于找线工具的卡尺参数，默认与对应粗找线模块相同，需要考虑搜索方向相反导致的卡尺极性可能不同，但是对找线模块数量做最小为5的限制，若数量小于5，则减小卡尺宽度。这些卡尺在输入图像界面上不显示（可以在粗找线结果界面显示，默认只显示由起始和终止点组成的矩形框），类似图12，用户可以调节矩形框的长度从而通过GUI交互设置起始和终止位置。</p>

<p>5.精细找线模块，该模块完成第三部分设置找线工具的找线，计算结果线段的中点，每个中点作为一个特征点。需要保证对边之间的特征点对应上，具体请按3.3准则输出。</p>

<p><img src="media/wps27.png" alt="img" /></p>

<p><imgnote>图12 粗找线工具编号示意图<imgnote></p>

<h2>注意</h2>

<p>无。</p>

<h2>示例工程</h2>

<p>参见“\Samples\轮廓特征点定位工具.gvp”。</p>
