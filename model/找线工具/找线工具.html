<head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../css/main.css" /> 
           <script src="../../js/jquery.js"></script> 
           <script src="../../js/main.js"></script> 
           </head> 
           <head> 
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../css/main.css" /> 
           <script src="../../../js/jquery.js"></script> 
           <script src="../../../js/main.js"></script> 
           </head>  
           <head>  
           <meta charset="utf-8"> 
           <link rel="stylesheet" href="../../../../css/main.css" /> 
           <script src="../../../../js/jquery.js"></script> 
           <script src="../../../../js/main.js"></script> 
           </head>
<h1>找线工具</h1>

<h2>1. 功能概述</h2>

<p>找线工具主要是在指定的ROI区域内对实际工件的直线边缘进行拟合，获取直线边缘的解析表达式，一般与定位工具配合使用，根据边缘极性等参数实现高精度的找线。其实际应用效果如图1所示。</p>

<p><img src="media/wps3.jpg" alt="img" /> <img src="media/wps4.jpg" alt="img" /></p>

<p><imgnote>(a)工具摆放示意图</imgnote> <imgnote>(b)找线结果</imgnote></p>

<p><imgnote>图1 找线工具应用示意图</imgnote></p>

<h2>2. 算法说明</h2>

<p>找线工具通过查找区域内卡尺参数的设置，寻找查找区域内的图像边缘点，然后对找到的边缘点进行直线拟合，从而寻找到一条目标直线，如下图所示。</p>

<p><img src="media/GcFindLineTool_2_1.png" alt="" /></p>

<h2>3. 应用场景</h2>

<p>找线工具的应用场景可以分为以下三个</p>

<ul>
<li>测量项目中可作为特征元素或中间元素参与尺寸测量，如测量线段与线段之间的距离，直线与直线之间的角度，或者通过线线、线圆求交点后，计算两点间距离等。</li>
<li>配合几何定位工具，通过找线工具、找圆工具、交点工具、中点工具等工具查找物料某些固定特征作为参考特征来实现精确定位。</li>
<li>在标定对位类项目中，可通过找线工具、找圆工具、交点工具，求取特定Mark点的图像坐标，配合对应机械坐标值，计算图像坐标系与机械坐标系的转换关系。</li>
</ul>


<h2>4. 使用向导</h2>

<h3>添加工具，链接参数</h3>

<ul>
<li><p>输入图像：待检测的图像</p></li>
<li><p>二维线性变换：该参数一般来源于定位工具，其表示为当前图像中的目标特征相对于模板图像中对应特征的平移、旋转、缩放变换。实时在线检测时，可通过该参数不断调整找线工具的查找区域。</p></li>
</ul>


<p><img src="media/GcFindLineTool_4_1.png" alt="" /></p>

<h3>设置检测参数</h3>

<p><img src="media/GcFindLineTool_4_2.png" alt="" /></p>

<p>重点参数说明如下，其余参数可参考“5.参数说明”。</p>

<h4>边缘模式</h4>

<p>单边缘和双边缘模式实际应用如图2和图3所示，采用单边缘模式时，其找线结果如图2(b)中的红色直线所示；若采用双边缘模式，卡尺摆放如图3(a)所示，卡尺的查找区域中包含两条边缘，找线结果为这两条边缘(图3(b)中绿色直线)的中线，如图3(b)中的红色直线所示。</p>

<p><img src="media/wps13.jpg" alt="img" />  <img src="media/wps14.jpg" alt="img" /></p>

<p><imgnote>(a) 找线区域设置</imgnote> <imgnote>(b) 找线结果</imgnote></p>

<p><imgnote>图2 单边缘模式示意图</imgnote></p>

<p><img src="media/wps15.jpg" alt="img" />   <img src="media/wps16.png" alt="img" /></p>

<p> <imgnote>(a) 找线区域设置</imgnote> <imgnote>(b) 找线结果</imgnote></p>

<p><imgnote>图3 双边缘模式示意图</imgnote></p>

<h4>边缘极性</h4>

<p>卡尺的边缘极性是根据图像边缘的灰度级过渡形式来确定的。如图4所示，沿着卡尺Y轴正方向(红色箭头所指的方向)，图像边缘的灰度级过渡形式如果是从亮到暗，则边缘极性选择亮到暗，反之选择暗到亮，如果图像边缘的灰度级过渡形式不确定时选择任意极性。</p>

<p><img src="media/wps17.png" alt="img" />   <img src="media/wps18.png" alt="img" /></p>

<p><imgnote>(a) 亮到暗</imgnote> <imgnote>(b) 暗到亮</imgnote></p>

<p><imgnote>图4 边缘极性示意图</imgnote></p>

<h4>局外点比例</h4>

<p>如图5所示，其中红色十字点为局外点，局外点是不参与拟合的。其中局外点所占比例称为局外点比例，图5中局外点比例为0.2。一般在边缘干扰过大时，需要设置局外点比例。</p>

<p><img src="media/wps19.jpg" alt="img" /></p>

<p><imgnote>图5 局外点示意图</imgnote></p>

<h4>边缘属性</h4>

<p>一般对于多边缘图像，需要设置合适的边缘属性。</p>

<p><img src="media/wps20.jpg" alt="img" /></p>

<p>  <imgnote>图6 边缘属性示意图</imgnote></p>

<p><strong>最佳边缘：</strong>在查找区域内，图像边缘相邻两侧灰度值相差最大的边缘；</p>

<p><strong>第一条边缘：</strong>在查找区域内，沿着卡尺Y轴的正方向，符合边缘极性的第一条图像边缘；</p>

<p><strong>最后一条边缘：</strong>在查找区域内，沿着卡尺Y轴的正方向，符合边缘极性的最后一条图像边缘；</p>

<p><strong>整体最亮边缘：</strong>在查找区域内，图像边缘两侧亮度平均值（灰度值平均值最大）的边缘；</p>

<p><strong>整体最暗边缘：</strong>在查找区域内，图像边缘两侧亮度平均值（灰度值平均值最小）的边缘；</p>

<p><strong>亮侧最亮边缘：</strong>在查找区域内，图像边缘亮侧最亮（亮侧灰度值最大）的边缘；</p>

<p><strong>亮侧最暗边缘：</strong>在查找区域内，图像边缘亮侧最暗（亮侧灰度值最小）的边缘；</p>

<p><strong>暗侧最亮边缘：</strong>在查找区域内，图像边缘暗侧最亮（暗侧灰度值最大）的边缘；</p>

<p><strong>暗侧最暗边缘：</strong>在查找区域内，图像边缘暗侧最暗（暗侧灰度值最小）的边缘。</p>

<p>选择双边缘模式时，边缘属性中的整体最亮边缘、整体最暗边缘、亮侧最亮边缘、亮侧最暗边缘、暗侧最亮边缘以及暗侧最暗边缘按最佳边缘处理。当查找范围为整个图像区域，边缘模式为单边缘，边缘极性设置为任意极性，选择不同的边缘属性时，其对应的找线结果如图6所示。</p>

<h4>开启平行偏移</h4>

<p>开启平行偏移参数选择“是”时，若平行偏移量参数输入为正时，直线结果向上(右)偏移得到平行偏移直线结果；反之，平行偏移量为负时，直线结果向下(左)偏移平行偏移直线结果。如图7所示，分别为平行偏移量参数输入为10和-10的输出结果图。</p>

<p><img src="media/wps21.jpg" alt="" />  <img src="media/wps22.jpg" alt="img" /></p>

<p><imgnote>(a) 平行偏移量参数输入正值</imgnote> <imgnote>(b) 平行偏移量参数输入负值</imgnote></p>

<p><imgnote>图7 开启平行偏移示意图</imgnote></p>

<h4>开启参考直线</h4>

<p>开启参考直线后可选择平行修正或垂直修正。</p>

<p>参考允许的角度偏差：结果直线与修正后的直线间的夹角，即夹角在参考允许的角度偏差下限与上限内时，开启参考直线修正可以进行平行或垂直修正，否则将不会进行修正。</p>

<p>平行修正：计算参考直线和选定直线的夹角并归一化到（-90,90），当夹角处于参考允许的角度偏差范围内时，找到拟合探测点中距离拟合直线最近的一个探测点，在此探测点上以参考直线角度作为斜率得到修正后的直线。修正前的线段结果的起始点和终止点投影在修正后的直线上得到新的修正点，修正点作为修正后线段的起始点和终止点，得到修正后线段。</p>

<p><img src="media/wps23.JPG" alt="" /><img src="media/wps24.JPG" alt="img" /></p>

<p><imgnote>(a) 原图像</imgnote> <imgnote>(b) 平行修正图像</imgnote></p>

<p><img src="media/wps27.JPG" alt="" /></p>

<p><imgnote>平行修正过程</imgnote></p>

<p>垂直修正：计算参考直线和选定直线的夹角并归一化到（-90,90），当夹角角度与90°的差值处于参考允许的角度偏差范围内时，获取选定直线的结果线段的起始点和终止点，以起始点和终止点的中点作为修正直线的经过点，参考直线与90°直线的角度差值作为修正直线的角度得到修正直线。修正前的线段结果的起始点和终止点投影在修正后的直线上得到新的修正点，修正点作为修正后线段的起始点和终止点，得到修正后线段。</p>

<p><img src="media/wps25.JPG" alt="" /><img src="media/wps26.JPG" alt="img" /></p>

<p><imgnote>(a) 原图像</imgnote> <imgnote>(b) 垂直修正图像</imgnote></p>

<p><img src="media/wps28.JPG" alt="" /></p>

<p><imgnote>垂直修正过程</imgnote></p>

<h4>设置结果上下限阈值</h4>

<p>找线工具增加了对检测结果（包括直线质心、直线绝对角度、直线变化角度）的判定功能，用户可开启或关闭对应检测结果的判定功能。当检测结果超出设置的上下限阈值时，判定工具运行失败，用户可根据此时工具的运行结果进行后续处理操作。如图8所示。</p>

<p><img src="media/GcFindLineTool_4_3.png" alt="" /></p>

<p><imgnote>图8 找线工具结果判定</imgnote></p>

<h2>5. 常见问题</h2>

<table>
<thead>
<tr>
<th> 现象描述                </th>
<th> 解决方法                                                     </th>
</tr>
</thead>
<tbody>
<tr>
<td> 找线ROI不能设置掩膜     </td>
<td> 查看属性栏参数“掩膜模式”是否选择“是”，选择“是”时才可以设置掩膜。 </td>
</tr>
<tr>
<td> 找线ROI不能设置卡尺参数 </td>
<td> 查看属性栏参数“手动模式”是否选择“是”，选择“是”时才可以设置卡尺参数。 </td>
</tr>
<tr>
<td> 找线失败                </td>
<td> 1. 查找失败。可根据输出窗口错误栏的错误提示，修改对比度阈值、局外点比例、复检模式等参数。<br />2. 判定失败。质心、直线绝对角度、直线变化角度判定上下限阈值设置不合理，可根据实际情况修改其上下限阈值 </td>
</tr>
</tbody>
</table>


<h2>6. 参数说明</h2>

<h3>输入参数</h3>

<table>
<thead>
<tr>
<th> 参数名称                                                 </th>
<th> 参数描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td> 输入图像                                                     </td>
<td> 输入图像宽度、高度、像素大小，同图像窗口的输入图像参数。     </td>
</tr>
<tr>
<td> 二维线性变换                   </td>
<td> 目标相对于模板的平移、旋转、缩放变换。</td>
</tr>
<tr>
<td> 参考平行/垂直角度直线          </td>
<td> 属性窗口开启参考直线参数，选择“是”时需要配置该参数。         </td>
</tr>
<tr>
<td> 参考平行位置直线               </td>
<td> 属性窗口开启参考直线参数，选择“是”时需要配置该参数。         </td>
</tr>
<tr>
<td> 查找区域 </td>
<td> 目标在图像中的查找范围，通过中心Center、尺寸Size和旋转Rotation对查找区域进行设置。 </td>
</tr>
<tr>
<td> 目标跟随     </td>
<td> 那个目标跟随开着的时候就是正常的，跟随二维线性变换的；如果关了就是即使链接了二维线性变换也不会用，应该是用来通过脚本工具动态设置找线区域的。 </td>
</tr>
<tr>
<td> 边缘模式                       </td>
<td> 卡尺工具的边缘模式有2种，单边缘和双边缘。<a href="#%E8%BE%B9%E7%BC%98%E6%A8%A1%E5%BC%8F"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 边缘极性                       </td>
<td> 边缘极性是指图像边缘灰度级的过渡形式，分为3种，任意极性、亮到暗和暗到亮。<a href="#%E8%BE%B9%E7%BC%98%E6%9E%81%E6%80%A7"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 对比度阈值                     </td>
<td> 卡尺工具默认只采用对比度评价分数，即按照边缘信号的强度来评分，输出边缘最强的点。对比度阈值的取值范围是0~255。 </td>
</tr>
<tr>
<td> 局外点比例                     </td>
<td> 局外点就是偏离曲线较远的点。局外点比例即不参与直线拟合的点的比例，取值范围是0~0.5。<a href="#%E5%B1%80%E5%A4%96%E7%82%B9%E6%AF%94%E4%BE%8B"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 边缘属性                       </td>
<td> 在查找区域内，卡尺根据不同的边缘属性，确定图像边缘的精确位置。<br />卡尺工具的边缘属性有9种，最佳边缘、第一条边缘、最后一条边缘、整体最亮边缘、整体最暗边缘、亮侧最亮边缘、亮侧最暗边缘、暗侧最亮边缘和暗侧最暗边缘。<a href="#%E8%BE%B9%E7%BC%98%E5%B1%9E%E6%80%A7"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 启用全局最优拟合               </td>
<td> 是否启用全局最优拟合                                         </td>
</tr>
<tr>
<td> 启用重新评分                   </td>
<td> 是否启用重新评分                                             </td>
</tr>
<tr>
<td> 允许减少局外点                 </td>
<td> 是否允许减少局外点                                           </td>
</tr>
<tr>
<td> 掩膜模式                       </td>
<td> 掩膜设置是指在模板训练过程中，屏蔽掉不参与模式训练的区域，减少参与模式训练的几何特征。 </td>
</tr>
<tr>
<td> 手动模式                       </td>
<td> 选择“是”，支持手动设置卡尺参数，鼠标右键点击卡尺，在弹出的对话框中可以改变卡尺参数；选择“否”，不支持手动设置卡尺参数。 </td>
</tr>
<tr>
<td> 实时显示结果                   </td>
<td> 选择“是”，在修改工具参数后，不需要运行工具，就可以实时显示结果；选择“否”，改变参数后需要运行工具才会显示对应的结果。 </td>
</tr>
<tr>
<td> 显示探测点                     </td>
<td> 选择“是”，显示卡尺的探测点，同时输出探测点，可以作为其他工具的输入参数；选择“否”，不显示卡尺的探测点。其中局外点用红色标注，其余用绿色标注。 </td>
</tr>
<tr>
<td> 复检模式                       </td>
<td> 如果找线失败，且开启了复检选项，则根据卡尺的模板变换后的结果输出直线。 </td>
</tr>
<tr>
<td> 开启平行偏移                   </td>
<td> 选择“是”，根据平行偏移量参数对结果直线，进行平移操作。<a href="#%E5%BC%80%E5%90%AF%E5%B9%B3%E8%A1%8C%E5%81%8F%E7%A7%BB"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 开启参考直线                   </td>
<td> 以指定参考直线为依据，对仿射矩形的搜索区域进行位置限制。选择“是”，显示修正类型参数、参考允许的角度偏差参数和参考直线距离参数。注意：当参考直线距离为0.000000的时候，相当于不开启参考直线。 </td>
</tr>
<tr>
<td> 修正类型                       </td>
<td> 修正类型分为2种，平行和垂直。                                </td>
</tr>
<tr>
<td> 参考允许的角度偏差             </td>
<td> 输入直线允许的角度偏差阈值，如果角度偏差超过阈值，以参考直线的角度修正。 </td>
</tr>
<tr>
<td> 参考直线距离 </td>
<td> 输入参考直线的距离。其中：左、上方为负值；右、下方为正值。   </td>
</tr>
<tr>
<td> 滤波半宽                       </td>
<td> 卡尺工具中涉及到对图像边缘进行滤波操作，滤波器半宽尺寸与图像边缘的锐度有关系。图像边缘的锐度越高，滤波器半宽尺寸可以设置的越小。滤波器半宽尺寸的取值范围为1~∞。 </td>
</tr>
<tr>
<td> 角度归一化                     </td>
<td> 角度归一化是指对结果直线的角度进行转换，使之限定在一定的范围内。角度归一化有4种，[-90°, 90°)、[-180°, 180°)、[0°, 180°)和[0°, 360°)。 </td>
</tr>
<tr>
<td> 质心X上限 </td>
<td> 测量结果质心位置坐标X的判断上限阈值，取值范围[0,999999.999999]， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 质心X下限 </td>
<td> 测量结果质心位置坐标X的判断下限阈值，取值范围[0,999999.999999]， 且下限应小于等于上限。<a href="#%E8%AE%BE%E7%BD%AE%E7%BB%93%E6%9E%9C%E4%B8%8A%E4%B8%8B%E9%99%90%E9%98%88%E5%80%BC"><img src="media/link.jpg" alt="img" /></a> </td>
</tr>
<tr>
<td> 质心Y上限 </td>
<td> 测量结果质心位置坐标Y的判断上限阈值，取值范围[0,999999.999999]， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 质心Y下限 </td>
<td> 测量结果质心位置坐标Y的判断下限阈值，取值范围[0,999999.999999]， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 直线绝对角度上限 </td>
<td> 测量结果直线绝对角度的判断上限阈值，取值范围[-180.0, 360.0)， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 直线绝对角度下限 </td>
<td> 测量结果直线绝对角度的判断下限阈值，取值范围[-180.0, 360.0)， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 直线变化角度上限 </td>
<td> 测量结果直线变化角度的判断上限阈值，取值范围[-90.0, 90.0)， 且下限应小于等于上限。 </td>
</tr>
<tr>
<td> 直线变化角度下限 </td>
<td> 测量结果直线变化角度的判断下限阈值，取值范围[-90.0, 90.0)， 且下限应小于等于上限。 </td>
</tr>
</tbody>
</table>


<h3>输出参数</h3>

<table>
<thead>
<tr>
<th> 参数名称                                                 </th>
<th> 参数描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td> 输入图像                                                     </td>
<td> 输出图像宽度、高度、像素大小。                           </td>
</tr>
<tr>
<td> 直线结果         </td>
<td> 直线的所经过点的位置坐标、方向向量和旋转角度。               </td>
</tr>
<tr>
<td> 线段结果         </td>
<td> 线段的起始点坐标和终止点坐标。                               </td>
</tr>
<tr>
<td> 直线绝对角度     </td>
<td> 输出直线的角度。                                             </td>
</tr>
<tr>
<td> 直线变化角度     </td>
<td> 输出直线相对于基准变化的角度。                               </td>
</tr>
<tr>
<td> 平行偏移直线结果 </td>
<td> 平行偏移直线的起始点坐标和方向向量。                         </td>
</tr>
<tr>
<td> 平行偏移线段结果 </td>
<td> 平行偏移线段的起始点坐标和终止点坐标。                       </td>
</tr>
<tr>
<td> 执行结果         </td>
<td> 工具执行结果。                                               </td>
</tr>
<tr>
<td> 执行时间         </td>
<td> 工具执行时间。                                               </td>
</tr>
</tbody>
</table>


<h2>7. 示例工程</h2>

<p>参见“\Samples\形状间距及相关点.gvp”。</p>
